name: Main
# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  watch:
    types: [started]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build-v8:
    runs-on: ubuntu-latest
    steps:
    - name: Maximize build space
      uses: easimon/maximize-build-space@v4
      with:
          root-reserve-mb: 512   
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-haskell: 'true'
          remove-android: 'true'
    - name: Checkout
      uses: actions/checkout@v2
    - name: Echo Free space
      run: |
          sudo apt purge -yq $(dpkg -l | grep '^ii' | awk '{ print $2 }' | grep -P '(cabal-|dotnet-|ghc-|libmono|php)') \
          liblldb-6.0 libllvm6.0:amd64 mono-runtime-common monodoc-manual powershell ruby
          sudo rm -rf /opt/az /usr/local /usr/share/dotnet
          sudo apt autoremove -yq
          echo "Free space:"
          df -h
    - name: ndk
      uses: actions/checkout@v2
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r21e
        add-to-path: true
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
    
    - name: Set up Python 2.x
      uses: actions/setup-python@v2
      with:
        python-version: '2.x'
    
    - name: Prepare
      run: |
        sudo apt-get install bzip2 cmake clang
    - name: Get Resource
      run: |
        export CC=clang
        export CXX=clang++
        git clone --depth 1 https://github.com/google/iree.git
        cd iree
        git submodule update --init --depth 1
        cmake -B ../iree-build/ -DCMAKE_BUILD_TYPE=RelWithDebInfo .
        cmake -B ../iree-build/ \
          -DCMAKE_INSTALL_PREFIX=../iree-build/install \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
        

